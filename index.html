<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Math Homework Feedback</title>
  <style>
    :root {
      color-scheme: light dark;
      --bg: #f6f7fb;
      --card-bg: #ffffff;
      --primary: #3c6e71;
      --primary-dark: #274c52;
      --accent: #d9f0ff;
      --text: #1f2933;
      --muted: #52606d;
      --border: #d2d6dc;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    *, *::before, *::after {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: linear-gradient(180deg, #f0f4f8 0%, #f6f7fb 40%, #ffffff 100%);
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 32px 16px;
    }

    .app-shell {
      width: min(960px, 100%);
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(12px);
      border-radius: 24px;
      border: 1px solid rgba(255, 255, 255, 0.6);
      box-shadow: 0 20px 45px rgba(31, 41, 51, 0.12);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    header {
      padding: 24px 32px;
      background: var(--primary);
      color: #fff;
    }

    header h1 {
      margin: 0;
      font-size: clamp(1.6rem, 2.4vw, 2.1rem);
      font-weight: 600;
    }

    header p {
      margin: 8px 0 0;
      font-size: 0.95rem;
      color: rgba(255, 255, 255, 0.88);
    }

    main {
      padding: 32px;
      display: grid;
      gap: 24px;
      position: relative;
    }

    .screen {
      display: none;
      animation: fade 260ms ease;
    }

    .screen.active {
      display: block;
    }

    @keyframes fade {
      from {
        opacity: 0;
        transform: translateY(12px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 24px;
      box-shadow: 0 12px 28px rgba(82, 96, 109, 0.08);
    }

    .step-heading {
      font-size: 1.35rem;
      margin-bottom: 12px;
      color: var(--primary-dark);
    }

    .step-description {
      margin: 0 0 24px;
      color: var(--muted);
    }

    .student-search {
      display: grid;
      gap: 16px;
    }

    .student-search input {
      width: 100%;
      padding: 14px 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
      font-size: 1rem;
    }

    .student-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 260px;
      overflow-y: auto;
      border: 1px solid var(--border);
      border-radius: 16px;
    }

    .student-list li {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid rgba(210, 214, 220, 0.6);
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 150ms ease, transform 150ms ease;
    }

    .student-list li:last-child {
      border-bottom: none;
    }

    .student-list li:hover {
      background: rgba(60, 110, 113, 0.08);
      transform: translateX(2px);
    }

    .student-list li.selected {
      background: rgba(60, 110, 113, 0.15);
      font-weight: 600;
    }

    .selection-badge {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      background: var(--primary);
      color: #fff;
      border-radius: 999px;
      padding: 2px 10px;
    }

    .controls {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      margin-top: 32px;
    }

    .controls button {
      flex: 1;
      padding: 14px 16px;
      border-radius: 12px;
      border: none;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 150ms ease, box-shadow 150ms ease;
    }

    .controls button.primary {
      background: var(--primary);
      color: #fff;
      box-shadow: 0 12px 24px rgba(60, 110, 113, 0.28);
    }

    .controls button.secondary {
      background: transparent;
      color: var(--primary-dark);
      border: 1px solid rgba(60, 110, 113, 0.4);
    }

    .controls button:disabled {
      opacity: 0.55;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .controls button:not(:disabled):hover {
      transform: translateY(-2px);
    }

    .field-group {
      display: grid;
      gap: 12px;
    }

    .field-group label {
      font-weight: 600;
      color: var(--primary-dark);
    }

    select {
      width: 100%;
      padding: 14px 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
      font-size: 1rem;
      background: #fff;
      appearance: none;
      background-image: url('data:image/svg+xml,%3Csvg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"%3E%3Cpath d="M6 9l6 6 6-6" stroke="%233c6e71" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/%3E%3C/svg%3E');
      background-repeat: no-repeat;
      background-position: right 12px center;
    }

    .summary-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(60, 110, 113, 0.12);
      color: var(--primary-dark);
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 0.9rem;
      margin: 6px 8px 0 0;
    }

    .problems {
      display: grid;
      gap: 16px;
    }

    .problem-card {
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 18px 20px;
      background: #fff;
      box-shadow: 0 10px 20px rgba(31, 41, 51, 0.08);
      display: grid;
      gap: 12px;
    }

    .problem-title {
      font-size: 1.05rem;
      font-weight: 600;
      color: var(--primary-dark);
    }

    .problem-description {
      color: var(--muted);
      margin: 0;
    }

    .options {
      display: grid;
      gap: 8px;
    }

    .option {
      display: flex;
      align-items: center;
      gap: 10px;
      border: 1px solid transparent;
      border-radius: 12px;
      padding: 8px 10px;
      transition: border 150ms ease, background 150ms ease;
    }

    .option input {
      accent-color: var(--primary);
      transform: scale(1.15);
    }

    .option.selected {
      background: rgba(60, 110, 113, 0.12);
      border-color: rgba(60, 110, 113, 0.45);
    }

    .status-banner {
      padding: 14px 18px;
      border-radius: 12px;
      font-weight: 600;
      background: rgba(60, 110, 113, 0.18);
      color: var(--primary-dark);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .status-banner.error {
      background: rgba(207, 83, 83, 0.18);
      color: #8b1f1f;
    }

    .status-banner.success {
      background: rgba(76, 175, 80, 0.18);
      color: #1b5e20;
    }

    .status-banner svg {
      width: 22px;
      height: 22px;
    }

    #loading-overlay {
      position: absolute;
      inset: 0;
      background: rgba(255, 255, 255, 0.92);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10;
      flex-direction: column;
      gap: 12px;
      font-weight: 600;
      color: var(--primary-dark);
    }

    #loading-overlay.show {
      display: flex;
    }

    .spinner {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      border: 4px solid rgba(60, 110, 113, 0.2);
      border-top-color: var(--primary);
      animation: spin 900ms linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(1turn);
      }
    }

    .final-screen {
      text-align: center;
      display: grid;
      gap: 18px;
      padding: 32px 16px;
    }

    .final-screen h2 {
      margin: 0;
      font-size: 1.8rem;
      color: var(--primary-dark);
    }

    .final-screen p {
      margin: 0;
      color: var(--muted);
      font-size: 1rem;
    }

    @media (max-width: 720px) {
      header,
      main {
        padding: 24px;
      }

      .controls {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <h1>Homework Confidence Check-In</h1>
      <p>Share how you felt about each homework problem so your teacher can support you.</p>
    </header>
    <main>
      <div id="loading-overlay">
        <div class="spinner" role="status" aria-label="Loading"></div>
        <span id="loading-message">Loading data...</span>
      </div>

      <div id="status-area"></div>

      <section class="screen active" data-screen="1">
        <div class="card">
          <h2 class="step-heading">Select Your Name</h2>
          <p class="step-description">Start typing to find and select your name from the class roster.</p>
          <div class="student-search">
            <input type="search" id="student-search" placeholder="Search for your name" autocomplete="off" aria-label="Search student" />
            <ul class="student-list" id="student-list" aria-label="Student results"></ul>
          </div>
          <div class="controls">
            <button type="button" class="secondary" disabled>Back</button>
            <button type="button" class="primary" id="to-screen-2" disabled>Next</button>
          </div>
        </div>
      </section>

      <section class="screen" data-screen="2">
        <div class="card">
          <h2 class="step-heading">Choose Your Assignment</h2>
          <p class="step-description">Pick the unit and lesson to load the matching homework problems.</p>
          <div class="field-group">
            <div>
              <label for="unit-select">Unit</label>
              <select id="unit-select" disabled>
                <option value="">Select unit</option>
              </select>
            </div>
            <div>
              <label for="lesson-select">Lesson</label>
              <select id="lesson-select" disabled>
                <option value="">Select lesson</option>
              </select>
            </div>
          </div>
          <div id="selection-summary"></div>
          <div class="controls">
            <button type="button" class="secondary" id="back-to-1">Back</button>
            <button type="button" class="primary" id="to-screen-3" disabled>Next</button>
          </div>
        </div>
      </section>

      <section class="screen" data-screen="3">
        <div class="card">
          <h2 class="step-heading">Reflect on Each Problem</h2>
          <p class="step-description">Choose the option that best describes how you felt about solving each problem.</p>
          <div class="status-banner" id="problem-status" hidden></div>
          <form id="response-form">
            <div class="problems" id="problems-container"></div>
            <div class="controls">
              <button type="button" class="secondary" id="back-to-2">Back</button>
              <button type="submit" class="primary" id="submit-feedback">Submit</button>
            </div>
          </form>
        </div>
      </section>

      <section class="screen" data-screen="4">
        <div class="card final-screen">
          <div>
            <h2>Thanks for sharing!</h2>
            <p>Your feedback was sent to your teacher.</p>
          </div>
          <button type="button" class="primary" id="start-over">Submit another assignment</button>
        </div>
      </section>
    </main>
  </div>

  <script>
    const DEFAULT_CONFIG = {
      AIRTABLE_API_KEY: 'patCUB0HwqgJr9nOr.d93cc816ba0e0dc0c22bbe5eaada139d84f864256b401446d1c2726da1247b4f',
      AIRTABLE_BASE_ID: 'appTwYDVvnYPB8D2N',
      TABLES: {
        STUDENTS: 'tblFr5ExAzNUYeLFU',
        PROBLEMS: 'tblE2IAeKV2TVEjJG',
        FEEDBACK: 'tblRNpi8trhwyuPA1'
      }
    };

    const CONFIG = Object.freeze({
      ...DEFAULT_CONFIG,
      ...(window.AIRTABLE_CONFIG || {}),
      TABLES: {
        ...DEFAULT_CONFIG.TABLES,
        ...((window.AIRTABLE_CONFIG && window.AIRTABLE_CONFIG.TABLES) || {})
      }
    });

    const REQUIRED_CONFIG_KEYS = [
      ['AIRTABLE_API_KEY', CONFIG.AIRTABLE_API_KEY],
      ['AIRTABLE_BASE_ID', CONFIG.AIRTABLE_BASE_ID],
      ['TABLES.STUDENTS', CONFIG.TABLES.STUDENTS]
    ];

    const SAMPLE_ASSIGNMENTS = [
      {
        unit: 'Unit 1 â€¢ Linear Relationships',
        lesson: 'Lesson 1.1 â€¢ Graphing from Tables',
        problems: [
          {
            id: 'sample-problem-1',
            label: 'Compare the slopes of two lines',
            description:
              'Two lines pass through the points (0, 2) & (4, 6) and (0, -1) & (4, 3). Which line is steeper? Explain.'
          },
          {
            id: 'sample-problem-2',
            label: 'Create a table for y = 3x - 2',
            description: 'Complete a table of values for x = -1, 0, 1, 2 and graph the resulting line.'
          }
        ]
      },
      {
        unit: 'Unit 2 â€¢ Systems of Equations',
        lesson: 'Lesson 2.3 â€¢ Elimination Method',
        problems: [
          {
            id: 'sample-problem-3',
            label: 'Solve 2x + 3y = 18 and x - 3y = 3',
            description: 'Use elimination to solve the system. Show each algebraic step you take.'
          },
          {
            id: 'sample-problem-4',
            label: 'Matching solutions',
            description:
              'Three solution pairs are shown. Decide which pair solves the system 4x - y = 7 and 2x + y = 9.'
          }
        ]
      }
    ];

    const FIELD_NAMES = {
      STUDENT_NAME: ['Name', 'Student Name', 'Full Name'],
      UNIT: ['Unit', 'Unit Name', 'Section Unit', 'Unit Number'],
      LESSON: ['Lesson', 'Lesson Name', 'Section Lesson', 'Lesson Number'],
      PROBLEM_TITLE: ['Problem', 'Problem Name', 'Title', 'Name', 'Math Concept'],
      PROBLEM_IDENTIFIER: ['Question Number', 'Problem Number', 'Prompt ID'],
      PROBLEM_DESCRIPTION: ['Prompt', 'Question', 'Description', 'Problem Text', 'Question Text'],
      PROBLEM_DETAILS: ['Reasoning', 'Choices', 'Rubric Items', 'Math Concept'],
      FEEDBACK_STUDENT_LINK: 'Student',
      FEEDBACK_STUDENT_NAME: 'Student Name',
      FEEDBACK_UNIT: 'Unit',
      FEEDBACK_LESSON: 'Lesson',
      FEEDBACK_PROBLEM_TEXT: 'Problem',
      FEEDBACK_PROBLEM_LINK: 'Problem Record',
      FEEDBACK_CONFIDENCE: 'Confidence',
      FEEDBACK_SUBMITTED_AT: 'Submitted At'
    };

    const RESPONSE_OPTIONS = [
      { value: 'could_not_approach', label: "Couldn't approach the problem", emoji: 'ðŸ˜•' },
      { value: 'unsure', label: 'Felt unsure about the answer', emoji: 'ðŸ¤”' },
      { value: 'okay', label: 'Felt okay', emoji: 'ðŸ™‚' },
      { value: 'confident', label: 'Confident in my answer', emoji: 'ðŸ’ª' }
    ];

    const state = {
      students: [],
      studentLookup: new Map(),
      units: [],
      lessonsByUnit: new Map(),
      problemsByKey: new Map(),
      selectedStudentId: null,
      selectedStudentName: '',
      selectedUnit: '',
      selectedLesson: '',
      responses: {}
    };

    const naturalSort = new Intl.Collator(undefined, { numeric: true, sensitivity: 'base' });

    const screens = Array.from(document.querySelectorAll('.screen'));
    const studentSearchInput = document.getElementById('student-search');
    const studentListElement = document.getElementById('student-list');
    const nextToScreen2Button = document.getElementById('to-screen-2');
    const backTo1Button = document.getElementById('back-to-1');
    const nextToScreen3Button = document.getElementById('to-screen-3');
    const backTo2Button = document.getElementById('back-to-2');
    const submitButton = document.getElementById('submit-feedback');
    const unitSelect = document.getElementById('unit-select');
    const lessonSelect = document.getElementById('lesson-select');
    const selectionSummary = document.getElementById('selection-summary');
    const problemsContainer = document.getElementById('problems-container');
    const problemStatus = document.getElementById('problem-status');
    const statusArea = document.getElementById('status-area');
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingMessage = document.getElementById('loading-message');
    const responseForm = document.getElementById('response-form');
    const restartButton = document.getElementById('start-over');

    document.addEventListener('DOMContentLoaded', initialiseApp);

    function isConfigured(value) {
      if (typeof value !== 'string') return false;
      const trimmed = value.trim();
      if (!trimmed) return false;
      return !/YOUR_[A-Z_]+/.test(trimmed) && !/REPLACE_[A-Z_]+/.test(trimmed);
    }

    function getMissingConfigKeys() {
      return REQUIRED_CONFIG_KEYS.filter(([, value]) => !isConfigured(value)).map(([key]) => key);
    }

    function disableAppForConfigurationIssue(message) {
      setLoading(false);
      showStatus(message, 'error');
      [nextToScreen2Button, nextToScreen3Button, submitButton, restartButton].forEach((element) => {
        if (element) {
          element.disabled = true;
        }
      });
      unitSelect.disabled = true;
      lessonSelect.disabled = true;
      studentSearchInput.disabled = true;
    }

    async function initialiseApp() {
      const missingConfig = getMissingConfigKeys();
      if (missingConfig.length) {
        disableAppForConfigurationIssue(
          `Set your Airtable credentials before using this tool. Missing: ${missingConfig.join(', ')}`
        );
        return;
      }

      try {
        setLoading(true, 'Loading your class roster...');
        await loadStudents();
        await loadProblems();
        renderStudents();
        populateUnits();
        setLoading(false);
        attachEventHandlers();
        showStatus(
          `Connected to Airtable base ${CONFIG.AIRTABLE_BASE_ID} using ${formatTableReference(
            CONFIG.TABLES.STUDENTS
          )} for the roster.`,
          'success',
          { append: true }
        );
      } catch (error) {
        console.error(error);
        showStatus(`We could not load the Airtable data. ${error.message}`, 'error');
        setLoading(false);
      }
    }

    function attachEventHandlers() {
      studentSearchInput.addEventListener('input', (event) => {
        renderStudents(event.target.value.trim().toLowerCase());
      });

      nextToScreen2Button.addEventListener('click', () => {
        goToScreen(2);
        updateSummary();
      });

      backTo1Button.addEventListener('click', () => {
        goToScreen(1);
      });

      unitSelect.addEventListener('change', (event) => {
        state.selectedUnit = event.target.value;
        state.selectedLesson = '';
        populateLessons();
        updateSummary();
        checkScreen2Ready();
      });

      lessonSelect.addEventListener('change', (event) => {
        state.selectedLesson = event.target.value;
        updateSummary();
        checkScreen2Ready();
      });

      nextToScreen3Button.addEventListener('click', () => {
        renderProblems();
        goToScreen(3);
      });

      backTo2Button.addEventListener('click', () => {
        goToScreen(2);
      });

      responseForm.addEventListener('change', (event) => {
        if (event.target.name && event.target.name.startsWith('problem-')) {
          const problemId = event.target.name.replace('problem-', '');
          state.responses[problemId] = event.target.value;
          highlightSelectedOption(problemId, event.target.value);
        }
      });

      responseForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        await handleSubmit();
      });

      restartButton.addEventListener('click', resetApp);
    }

    function goToScreen(screenNumber) {
      screens.forEach((screen) => {
        screen.classList.toggle('active', screen.dataset.screen === String(screenNumber));
      });
    }

    function setLoading(isLoading, message = 'Loading...') {
      if (isLoading) {
        loadingOverlay.classList.add('show');
        loadingMessage.textContent = message;
      } else {
        loadingOverlay.classList.remove('show');
      }
    }

    function showStatus(message, type = 'info', options = {}) {
      const { append = false } = options;
      if (!append) {
        statusArea.innerHTML = '';
      }
      if (!message) return;
      const wrapper = document.createElement('div');
      wrapper.className = `status-banner ${type === 'error' ? 'error' : type === 'success' ? 'success' : ''}`;
      wrapper.textContent = message;
      statusArea.appendChild(wrapper);
    }

    function formatTableReference(identifier) {
      if (typeof identifier !== 'string') {
        return 'an unknown table';
      }

      const trimmed = identifier.trim();
      if (!trimmed) {
        return 'an unknown table';
      }

      if (/^tbl[a-zA-Z0-9]{14}$/.test(trimmed)) {
        return `table ID ${trimmed}`;
      }

      return `table "${trimmed}"`;
    }

    async function loadStudents() {
      const records = await airtableFetch(CONFIG.TABLES.STUDENTS, { pageSize: 100 });
      state.students = records
        .map((record) => {
          const name = extractFirstAvailable(record.fields, FIELD_NAMES.STUDENT_NAME);
          return name ? { id: record.id, name } : null;
        })
        .filter(Boolean)
        .sort((a, b) => a.name.localeCompare(b.name));

      state.studentLookup.clear();
      state.students.forEach((student) => {
        state.studentLookup.set(student.id, student);
        state.studentLookup.set(student.name.toLowerCase(), student);
      });
    }

    async function loadProblems() {
      if (!isConfigured(CONFIG.TABLES.PROBLEMS)) {
        useSampleProblems('Using sample assignments until an Airtable problems table is connected.');
        return;
      }

      try {
        const records = await airtableFetch(CONFIG.TABLES.PROBLEMS, { pageSize: 100 });
        const lessonsByUnit = new Map();
        const problemsByKey = new Map();
        const units = new Set();

        records.forEach((record) => {
          const unit = extractFirstAvailable(record.fields, FIELD_NAMES.UNIT);
          const lesson = extractFirstAvailable(record.fields, FIELD_NAMES.LESSON);
          if (!unit || !lesson) {
            return;
          }

          units.add(unit);
          if (!lessonsByUnit.has(unit)) {
            lessonsByUnit.set(unit, new Set());
          }
          lessonsByUnit.get(unit).add(lesson);

          const key = `${unit}|||${lesson}`;
          if (!problemsByKey.has(key)) {
            problemsByKey.set(key, []);
          }

          const identifier = extractFirstAvailable(record.fields, FIELD_NAMES.PROBLEM_IDENTIFIER);
          const title = extractFirstAvailable(record.fields, FIELD_NAMES.PROBLEM_TITLE);
          const primaryDescription = extractFirstAvailable(record.fields, FIELD_NAMES.PROBLEM_DESCRIPTION);
          const secondaryDescription = extractFirstAvailable(record.fields, FIELD_NAMES.PROBLEM_DETAILS);

          let label = title;
          if (identifier) {
            label = title ? `${identifier} â€¢ ${title}` : `Problem ${identifier}`;
          }
          if (!label) {
            const index = problemsByKey.get(key).length + 1;
            label = identifier ? `Problem ${identifier}` : `Problem ${index}`;
          }

          const descriptionParts = [];
          if (primaryDescription) {
            descriptionParts.push(String(primaryDescription).trim());
          }
          if (secondaryDescription && secondaryDescription !== primaryDescription) {
            const detail = String(secondaryDescription).trim();
            if (detail && !descriptionParts.includes(detail)) {
              descriptionParts.push(detail);
            }
          }

          const description = descriptionParts.join('\n\n');

          problemsByKey.get(key).push({
            id: record.id,
            label,
            description,
            fields: record.fields
          });
        });

        state.units = Array.from(units).sort((a, b) => naturalSort.compare(a, b));
        state.lessonsByUnit = new Map(
          Array.from(lessonsByUnit.entries()).map(([unit, lessons]) => [unit, Array.from(lessons).sort((a, b) => naturalSort.compare(a, b))])
        );
        state.problemsByKey = problemsByKey;

        if (!state.units.length) {
          useSampleProblems('No problems were found in Airtable. Loaded sample assignments so you can demo the flow.');
        }
      } catch (error) {
        console.warn('Falling back to sample assignments after Airtable error.', error);
        useSampleProblems('We could not load assignments from Airtable. Showing sample data for now.');
      }
    }

    function useSampleProblems(message) {
      const lessonsByUnit = new Map();
      const problemsByKey = new Map();

      const unitSet = new Set();

      SAMPLE_ASSIGNMENTS.forEach((assignment) => {
        unitSet.add(assignment.unit);
        if (!lessonsByUnit.has(assignment.unit)) {
          lessonsByUnit.set(assignment.unit, new Set());
        }
        lessonsByUnit.get(assignment.unit).add(assignment.lesson);

        const key = `${assignment.unit}|||${assignment.lesson}`;
        problemsByKey.set(
          key,
          assignment.problems.map((problem, index) => ({
            id: problem.id,
            label: problem.label || `Problem ${index + 1}`,
            description: problem.description
          }))
        );
      });

      state.units = Array.from(unitSet).sort((a, b) => naturalSort.compare(a, b));
      state.lessonsByUnit = new Map(
        Array.from(lessonsByUnit.entries()).map(([unit, lessons]) => [unit, Array.from(lessons).sort((a, b) => naturalSort.compare(a, b))])
      );
      state.problemsByKey = problemsByKey;
      showStatus(message, 'info', { append: true });
    }

    function extractFirstAvailable(fields, candidates) {
      if (!fields) return undefined;
      const list = Array.isArray(candidates) ? candidates : [candidates];
      for (const key of list) {
        if (key in fields && fields[key] != null && String(fields[key]).trim() !== '') {
          return Array.isArray(fields[key]) ? fields[key][0] : fields[key];
        }
      }
      const fallback = Object.values(fields).find((value) => typeof value === 'string' && value.trim().length);
      return fallback;
    }

    function renderStudents(filter = '') {
      studentListElement.innerHTML = '';
      const filtered = filter
        ? state.students.filter((student) => student.name.toLowerCase().includes(filter))
        : state.students;

      if (!filtered.length) {
        const empty = document.createElement('li');
        empty.textContent = 'No students found';
        empty.style.color = 'var(--muted)';
        empty.style.cursor = 'default';
        studentListElement.appendChild(empty);
        return;
      }

      filtered.forEach((student) => {
        const item = document.createElement('li');
        item.textContent = student.name;
        if (state.selectedStudentId === student.id) {
          item.classList.add('selected');
          const badge = document.createElement('span');
          badge.className = 'selection-badge';
          badge.textContent = 'Selected';
          item.appendChild(badge);
        }
        item.addEventListener('click', () => {
          state.selectedStudentId = student.id;
          state.selectedStudentName = student.name;
          nextToScreen2Button.disabled = false;
          renderStudents(filter);
        });
        studentListElement.appendChild(item);
      });
    }

    function populateUnits() {
      unitSelect.innerHTML = '<option value="">Select unit</option>';
      state.units.forEach((unit) => {
        const option = document.createElement('option');
        option.value = unit;
        option.textContent = unit;
        unitSelect.appendChild(option);
      });
      unitSelect.disabled = state.units.length === 0;
    }

    function populateLessons() {
      lessonSelect.innerHTML = '<option value="">Select lesson</option>';
      if (!state.selectedUnit) {
        lessonSelect.disabled = true;
        return;
      }

      const lessons = state.lessonsByUnit.get(state.selectedUnit) || [];
      lessons.forEach((lesson) => {
        const option = document.createElement('option');
        option.value = lesson;
        option.textContent = lesson;
        lessonSelect.appendChild(option);
      });
      lessonSelect.disabled = lessons.length === 0;
    }

    function updateSummary() {
      selectionSummary.innerHTML = '';
      if (state.selectedStudentName) {
        selectionSummary.appendChild(createSummaryChip('Student', state.selectedStudentName));
      }
      if (state.selectedUnit) {
        selectionSummary.appendChild(createSummaryChip('Unit', state.selectedUnit));
      }
      if (state.selectedLesson) {
        selectionSummary.appendChild(createSummaryChip('Lesson', state.selectedLesson));
      }
    }

    function createSummaryChip(label, value) {
      const chip = document.createElement('span');
      chip.className = 'summary-chip';
      chip.textContent = `${label}: ${value}`;
      return chip;
    }

    function checkScreen2Ready() {
      const ready = Boolean(state.selectedUnit && state.selectedLesson);
      nextToScreen3Button.disabled = !ready;
    }

    function renderProblems() {
      problemsContainer.innerHTML = '';
      problemStatus.hidden = true;
      const key = `${state.selectedUnit}|||${state.selectedLesson}`;
      const problems = state.problemsByKey.get(key) || [];

      if (!problems.length) {
        problemStatus.hidden = false;
        problemStatus.classList.remove('success');
        problemStatus.classList.add('error');
        problemStatus.textContent = 'No problems were found for that unit and lesson.';
        submitButton.disabled = true;
        return;
      }

      submitButton.disabled = false;
      state.responses = {};

      problems.forEach((problem) => {
        const card = document.createElement('fieldset');
        card.className = 'problem-card';
        card.id = `problem-${problem.id}`;

        const legend = document.createElement('legend');
        legend.className = 'problem-title';
        legend.textContent = problem.label;
        card.appendChild(legend);

        if (problem.description) {
          const description = document.createElement('p');
          description.className = 'problem-description';
          description.textContent = problem.description;
          card.appendChild(description);
        }

        const optionsContainer = document.createElement('div');
        optionsContainer.className = 'options';

        RESPONSE_OPTIONS.forEach((option) => {
          const optionWrapper = document.createElement('label');
          optionWrapper.className = 'option';

          const input = document.createElement('input');
          input.type = 'radio';
          input.name = `problem-${problem.id}`;
          input.value = option.value;

          const text = document.createElement('span');
          text.textContent = `${option.emoji} ${option.label}`;

          optionWrapper.appendChild(input);
          optionWrapper.appendChild(text);
          optionsContainer.appendChild(optionWrapper);
        });

        card.appendChild(optionsContainer);
        problemsContainer.appendChild(card);
      });
    }

    function highlightSelectedOption(problemId, value) {
      const fieldset = document.getElementById(`problem-${problemId}`);
      if (!fieldset) return;
      const options = fieldset.querySelectorAll('.option');
      options.forEach((wrapper) => {
        const input = wrapper.querySelector('input[type="radio"]');
        if (input.value === value && input.checked) {
          wrapper.classList.add('selected');
        } else {
          wrapper.classList.remove('selected');
        }
      });
    }

    async function handleSubmit() {
      const key = `${state.selectedUnit}|||${state.selectedLesson}`;
      const problems = state.problemsByKey.get(key) || [];
      const unanswered = problems.filter((problem) => !state.responses[problem.id]);

      if (unanswered.length) {
        showProblemStatus('Please answer every problem before submitting.', 'error');
        return;
      }

      try {
        submitButton.disabled = true;
        setLoading(true, 'Submitting your feedback...');
        const payload = {
          records: problems.map((problem) => ({
            fields: buildFeedbackFields(problem)
          })),
          typecast: true
        };

        if (isConfigured(CONFIG.TABLES.FEEDBACK)) {
          await airtableCreate(CONFIG.TABLES.FEEDBACK, payload);
          showStatus('Your responses were saved!', 'success');
        } else {
          await new Promise((resolve) => setTimeout(resolve, 400));
          showStatus('Responses recorded for this demo. Connect a feedback table to save them to Airtable.', 'success');
        }

        setLoading(false);
        goToScreen(4);
      } catch (error) {
        console.error(error);
        setLoading(false);
        submitButton.disabled = false;
        showProblemStatus(`We could not submit your responses. ${error.message}`, 'error');
      }
    }

    function showProblemStatus(message, type) {
      problemStatus.hidden = false;
      problemStatus.textContent = message;
      problemStatus.classList.toggle('error', type === 'error');
      problemStatus.classList.toggle('success', type === 'success');
    }

    function buildFeedbackFields(problem) {
      const fields = {};
      if (FIELD_NAMES.FEEDBACK_STUDENT_LINK) {
        fields[FIELD_NAMES.FEEDBACK_STUDENT_LINK] = [state.selectedStudentId];
      }
      if (FIELD_NAMES.FEEDBACK_STUDENT_NAME) {
        fields[FIELD_NAMES.FEEDBACK_STUDENT_NAME] = state.selectedStudentName;
      }
      if (FIELD_NAMES.FEEDBACK_UNIT) {
        fields[FIELD_NAMES.FEEDBACK_UNIT] = state.selectedUnit;
      }
      if (FIELD_NAMES.FEEDBACK_LESSON) {
        fields[FIELD_NAMES.FEEDBACK_LESSON] = state.selectedLesson;
      }
      if (FIELD_NAMES.FEEDBACK_PROBLEM_TEXT) {
        fields[FIELD_NAMES.FEEDBACK_PROBLEM_TEXT] = problem.label;
      }
      if (FIELD_NAMES.FEEDBACK_PROBLEM_LINK) {
        fields[FIELD_NAMES.FEEDBACK_PROBLEM_LINK] = [problem.id];
      }
      if (FIELD_NAMES.FEEDBACK_CONFIDENCE) {
        fields[FIELD_NAMES.FEEDBACK_CONFIDENCE] = state.responses[problem.id];
      }
      if (FIELD_NAMES.FEEDBACK_SUBMITTED_AT) {
        fields[FIELD_NAMES.FEEDBACK_SUBMITTED_AT] = new Date().toISOString();
      }
      return fields;
    }

    async function airtableFetch(tableId, params = {}) {
      const url = new URL(`https://api.airtable.com/v0/${CONFIG.AIRTABLE_BASE_ID}/${tableId}`);
      Object.entries(params).forEach(([key, value]) => {
        if (value != null) {
          url.searchParams.append(key, value);
        }
      });

      const records = [];
      let offset;
      do {
        if (offset) {
          url.searchParams.set('offset', offset);
        }
        const response = await fetch(url.toString(), {
          headers: {
            Authorization: `Bearer ${CONFIG.AIRTABLE_API_KEY}`
          }
        });
        if (!response.ok) {
          const text = await response.text();
          throw new Error(`Airtable request failed (${response.status}). ${text}`);
        }
        const data = await response.json();
        records.push(...data.records);
        offset = data.offset;
      } while (offset);

      return records;
    }

    async function airtableCreate(tableId, payload) {
      const response = await fetch(`https://api.airtable.com/v0/${CONFIG.AIRTABLE_BASE_ID}/${tableId}`, {
        method: 'POST',
        headers: {
          Authorization: `Bearer ${CONFIG.AIRTABLE_API_KEY}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      });

      if (!response.ok) {
        const text = await response.text();
        throw new Error(`Airtable submission failed (${response.status}). ${text}`);
      }

      return response.json();
    }

    function resetApp() {
      state.selectedUnit = '';
      state.selectedLesson = '';
      state.responses = {};
      unitSelect.value = '';
      lessonSelect.value = '';
      populateLessons();
      checkScreen2Ready();

      state.selectedStudentId = null;
      state.selectedStudentName = '';
      studentSearchInput.value = '';
      nextToScreen2Button.disabled = true;
      renderStudents();
      updateSummary();
      goToScreen(1);
    }
  </script>
</body>
</html>
